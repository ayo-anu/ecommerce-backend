name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run integration tests daily at 2 AM
    - cron: '0 2 * * *'

jobs:
  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create .env file
        run: |
          cat > infrastructure/env/.env.development << EOF
          # Database
          DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce
          POSTGRES_AI_DB=ecommerce_ai
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres

          # Redis
          REDIS_PASSWORD=redis_password
          REDIS_URL=redis://:redis_password@redis:6379/0

          # Django
          SECRET_KEY=test-secret-key-for-integration-tests
          DEBUG=False
          ALLOWED_HOSTS=backend,localhost,127.0.0.1

          # Service Authentication Keys (for testing)
          SERVICE_AUTH_SECRET_DJANGO_BACKEND=test-service-auth-backend-secret-key-min-32-chars-long
          SERVICE_AUTH_SECRET_API_GATEWAY=test-service-auth-gateway-secret-key-min-32-chars-long
          SERVICE_AUTH_SECRET_CELERY_WORKER=test-service-auth-celery-secret-key-min-32-chars-long

          # AI Services
          LOG_LEVEL=INFO

          # Disable external services
          OPENAI_API_KEY=sk-test-key
          STRIPE_SECRET_KEY=sk_test_key
          STRIPE_PUBLISHABLE_KEY=pk_test_key
          EOF

      - name: Start services with Docker Compose
        run: |
          docker-compose -f infrastructure/docker-compose.yaml \
                         -f infrastructure/docker-compose.dev.yaml \
                         up -d

      - name: Wait for services to be healthy
        run: |
          pip install requests
          python scripts/health_check.py --wait --timeout 300

      - name: Run migrations
        run: |
          docker-compose exec -T backend python manage.py migrate --noinput

      - name: Install test dependencies
        run: |
          pip install -r tests/integration/requirements.txt

      - name: Run integration tests
        env:
          BACKEND_URL: http://localhost:8000
          GATEWAY_URL: http://localhost:8080
          FRONTEND_URL: http://localhost:3000
        run: |
          pytest tests/integration/ -v --tb=short

      - name: Collect logs on failure
        if: failure()
        run: |
          mkdir -p logs
          docker-compose logs backend > logs/backend.log
          docker-compose logs api_gateway > logs/gateway.log
          docker-compose logs frontend > logs/frontend.log
          docker-compose logs recommender > logs/recommender.log

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: logs/

      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v

  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: Install Playwright
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps

      - name: Start services
        run: |
          docker-compose -f infrastructure/docker-compose.yaml \
                         -f infrastructure/docker-compose.dev.yaml \
                         up -d

      - name: Wait for services
        run: |
          pip install requests
          python scripts/health_check.py --wait --timeout 300

      - name: Run E2E tests
        run: |
          cd frontend
          npx playwright test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v
