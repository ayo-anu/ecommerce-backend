name: Load Testing

on:
  # Run on pull requests to main
  pull_request:
    branches: [main]
    paths:
      - 'services/backend/**'
      - '.github/workflows/load-test.yml'

  # Run on schedule (weekly)
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_profile:
        description: 'Test profile to run'
        required: true
        default: 'baseline'
        type: choice
        options:
          - smoke
          - baseline
          - load
          - stress
      host:
        description: 'Target host URL'
        required: true
        default: 'http://localhost:8000'

env:
  PYTHON_VERSION: '3.11'

jobs:
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: ecommerce_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: services/backend
        run: |
          pip install --upgrade pip
          pip install -r requirements/base.txt
          pip install -r requirements/dev.txt

      - name: Set up environment variables
        working-directory: services/backend
        run: |
          cp .env.example .env
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/ecommerce_test" >> .env
          echo "REDIS_URL=redis://localhost:6379/0" >> .env
          echo "SECRET_KEY=test-secret-key-for-ci" >> .env
          echo "DEBUG=False" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> .env

      - name: Run database migrations
        working-directory: services/backend
        run: |
          python manage.py migrate --noinput

      - name: Create test data
        working-directory: services/backend
        run: |
          python manage.py shell <<EOF
          from apps.products.models import Product, Category
          from apps.accounts.models import User
          from decimal import Decimal

          # Create test users
          for i in range(1, 11):
              User.objects.create_user(
                  email=f'testuser{i}@example.com',
                  password='testpass123',
                  first_name=f'Test{i}',
                  last_name='User'
              )

          # Create test categories
          categories = []
          for cat_name in ['electronics', 'clothing', 'books', 'home', 'sports']:
              cat, _ = Category.objects.get_or_create(
                  name=cat_name,
                  defaults={'slug': cat_name}
              )
              categories.append(cat)

          # Create test products
          for i in range(1, 101):
              Product.objects.create(
                  name=f'Test Product {i}',
                  slug=f'test-product-{i}',
                  description=f'Description for product {i}',
                  price=Decimal('99.99'),
                  stock=100,
                  category=categories[i % len(categories)]
              )

          print('Test data created successfully')
          EOF

      - name: Start application server
        working-directory: services/backend
        run: |
          gunicorn config.wsgi:application \
            --bind 0.0.0.0:8000 \
            --workers 4 \
            --timeout 120 \
            --access-logfile - \
            --error-logfile - \
            &
          echo $! > gunicorn.pid

          # Wait for server to be ready
          timeout 30 bash -c 'until curl -sf http://localhost:8000/api/health/; do sleep 1; done'

      - name: Determine test profile
        id: test-profile
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ github.event.inputs.test_profile }}" >> $GITHUB_OUTPUT
            echo "host=${{ github.event.inputs.host }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "profile=smoke" >> $GITHUB_OUTPUT
            echo "host=http://localhost:8000" >> $GITHUB_OUTPUT
          else
            echo "profile=baseline" >> $GITHUB_OUTPUT
            echo "host=http://localhost:8000" >> $GITHUB_OUTPUT
          fi

      - name: Run load tests
        working-directory: services/backend/tests/load
        run: |
          ./run_load_test.sh ${{ steps.test-profile.outputs.profile }} ${{ steps.test-profile.outputs.host }}
        continue-on-error: true

      - name: Analyze results
        id: analyze
        working-directory: services/backend/tests/load
        run: |
          LATEST_STATS=$(ls -t reports/*_stats.csv | head -1)
          ./analyze_results.py "$LATEST_STATS" --baseline config/baselines.json || true
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-reports-${{ steps.test-profile.outputs.profile }}-${{ github.run_number }}
          path: services/backend/tests/load/reports/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const statsFile = fs.readdirSync('services/backend/tests/load/reports/')
              .filter(f => f.endsWith('_stats.csv'))
              .sort()
              .pop();

            if (!statsFile) {
              console.log('No stats file found');
              return;
            }

            const stats = fs.readFileSync(`services/backend/tests/load/reports/${statsFile}`, 'utf8');
            const lines = stats.split('\n');
            const header = lines[0];
            const data = lines.slice(1, 6); // Top 5 endpoints

            const comment = `## Load Test Results üöÄ

            **Profile:** ${{ steps.test-profile.outputs.profile }}
            **Status:** ${{ steps.analyze.outputs.exit_code == '0' && '‚úÖ PASS' || steps.analyze.outputs.exit_code == '1' && '‚ö†Ô∏è WARN' || '‚ùå FAIL' }}

            **Top Endpoints by Response Time:**
            \`\`\`
            ${header}
            ${data.join('\n')}
            \`\`\`

            üìä Full report available in artifacts.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Stop application server
        if: always()
        working-directory: services/backend
        run: |
          if [ -f gunicorn.pid ]; then
            kill $(cat gunicorn.pid) || true
          fi

      - name: Check for critical regressions
        if: steps.analyze.outputs.exit_code == '2'
        run: |
          echo "Critical performance regressions detected!"
          exit 1
