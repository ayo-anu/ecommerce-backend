name: Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - develop
      - 'phase-*/**'
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: Lint and Format Checks
  lint-backend:
    name: Backend Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd services/backend
          pip install --upgrade pip
          pip install -r requirements/dev.txt

      - name: Run flake8
        run: |
          cd services/backend
          flake8 apps/ config/ core/ --max-line-length=120 --exclude=migrations

      - name: Run pylint
        run: |
          cd services/backend
          pylint apps/ config/ core/ --disable=C0111,R0903 || true

      - name: Check imports with isort
        run: |
          cd services/backend
          isort --check-only --diff apps/ config/ core/

      - name: Run black format check
        run: |
          cd services/backend
          black --check apps/ config/ core/

  lint-ai-services:
    name: AI Services Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd services/ai
          pip install --upgrade pip
          pip install flake8 black isort

      - name: Run flake8
        run: |
          cd services/ai
          flake8 services/ shared/ --max-line-length=120

      - name: Run black
        run: |
          cd services/ai
          black --check services/ shared/

  # Job 2: Unit Tests
  test-backend:
    name: Backend Unit Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd services/backend
          pip install --upgrade pip
          pip install -r requirements/tests.txt

      - name: Run migrations
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          DJANGO_SETTINGS_MODULE: config.settings.tests
        run: |
          cd services/backend
          python manage.py migrate --noinput

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SETTINGS_MODULE: config.settings.tests
        run: |
          cd services/backend
          pytest tests/unit/ -v --cov=apps --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./services/backend/coverage.xml
          flags: backend
          name: backend-coverage

  test-ai-services:
    name: AI Services Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd services/ai
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio

      - name: Run AI services tests
        run: |
          cd services/ai
          pytest services/*/tests/ -v --cov=services --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./services/ai/coverage.xml
          flags: ai-services
          name: ai-services-coverage

  # Job 3: Build Validation
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./services/backend
          file: ./services/backend/Dockerfile
          push: false
          tags: backend:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.pull_request.updated_at }}
            VCS_REF=${{ github.sha }}

  build-ai-gateway:
    name: Build AI Gateway Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build AI gateway image
        uses: docker/build-push-action@v5
        with:
          context: ./services/ai/api_gateway
          file: ./services/ai/api_gateway/Dockerfile
          push: false
          tags: api-gateway:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 4: Integration Tests (Quick)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-backend, build-ai-gateway]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test environment file
        run: |
          cat > .env.test <<EOF
          DEBUG=True
          SECRET_KEY=test-secret-key-for-ci
          DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce_test
          REDIS_URL=redis://redis:6379/0
          CELERY_BROKER_URL=redis://redis:6379/1
          ALLOWED_HOSTS=localhost,127.0.0.1
          EOF

      - name: Start test environment
        run: |
          docker-compose -f deploy/docker/compose/ci.yml up -d
          sleep 30

      - name: Wait for services to be healthy
        run: |
          timeout 120 bash -c 'until docker-compose -f deploy/docker/compose/ci.yml ps | grep -q "healthy"; do sleep 5; done'

      - name: Run integration tests
        run: |
          docker-compose -f deploy/docker/compose/ci.yml exec -T backend \
            pytest tests/integration/ -v --maxfail=5

      - name: Show logs on failure
        if: failure()
        run: |
          docker-compose -f deploy/docker/compose/ci.yml logs

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f deploy/docker/compose/ci.yml down -v

  # Job 5: Security Scan Preview (Quick)
  security-preview:
    name: Security Scan Preview
    runs-on: ubuntu-latest
    needs: [build-backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './services/backend'
          format: 'table'
          exit-code: '0'  # Don't fail PR, just show results
          severity: 'CRITICAL,HIGH'

  # Job 6: PR Summary
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint-backend, lint-ai-services, test-backend, test-ai-services, build-backend, build-ai-gateway, integration-tests, security-preview]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "All PR checks completed!"
          echo "Lint Backend: ${{ needs.lint-backend.result }}"
          echo "Lint AI Services: ${{ needs.lint-ai-services.result }}"
          echo "Test Backend: ${{ needs.test-backend.result }}"
          echo "Test AI Services: ${{ needs.test-ai-services.result }}"
          echo "Build Backend: ${{ needs.build-backend.result }}"
          echo "Build AI Gateway: ${{ needs.build-ai-gateway.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Security Preview: ${{ needs.security-preview.result }}"

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const results = {
              'Lint Backend': '${{ needs.lint-backend.result }}',
              'Lint AI Services': '${{ needs.lint-ai-services.result }}',
              'Test Backend': '${{ needs.test-backend.result }}',
              'Test AI Services': '${{ needs.test-ai-services.result }}',
              'Build Backend': '${{ needs.build-backend.result }}',
              'Build AI Gateway': '${{ needs.build-ai-gateway.result }}',
              'Integration Tests': '${{ needs.integration-tests.result }}',
              'Security Preview': '${{ needs.security-preview.result }}'
            };

            const passed = Object.values(results).every(r => r === 'success');
            const emoji = passed ? '✅' : '❌';

            let body = `## ${emoji} PR Checks Summary\n\n`;
            body += '| Check | Status |\n';
            body += '|-------|--------|\n';

            for (const [check, result] of Object.entries(results)) {
              const statusEmoji = result === 'success' ? '✅' : '❌';
              body += `| ${check} | ${statusEmoji} ${result} |\n`;
            }

            body += '\n---\n';
            body += `**Commit:** ${context.sha.substring(0, 7)}\n`;
            body += `**Triggered by:** @${context.actor}\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if any check failed
        if: |
          needs.lint-backend.result != 'success' ||
          needs.lint-ai-services.result != 'success' ||
          needs.test-backend.result != 'success' ||
          needs.test-ai-services.result != 'success' ||
          needs.build-backend.result != 'success' ||
          needs.build-ai-gateway.result != 'success' ||
          needs.integration-tests.result != 'success'
        run: |
          echo "One or more checks failed!"
          exit 1
