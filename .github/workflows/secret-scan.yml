# ==============================================================================
# Secret Scanning Workflow
# ==============================================================================
# Scans repository for secrets, API keys, tokens, and credentials
#
# Triggers:
#   - All pushes and pull requests
#   - Scheduled daily scans
#   - Manual workflow dispatch
#
# Tools:
#   - Gitleaks: Primary secret scanner
#   - TruffleHog: Secondary validation
#   - detect-secrets: Additional coverage
# ==============================================================================

name: Secret Scanning

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ============================================================================
  # Job 1: Gitleaks Scan
  # ============================================================================
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Upload Gitleaks report
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # ============================================================================
  # Job 2: TruffleHog Scan
  # ============================================================================
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Upload TruffleHog results
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: trufflehog-results
          path: trufflehog-*.json

  # ============================================================================
  # Job 3: detect-secrets Scan
  # ============================================================================
  detect-secrets:
    name: detect-secrets Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Create baseline if not exists
        run: |
          if [ ! -f .secrets.baseline ]; then
            echo "Creating secrets baseline..."
            detect-secrets scan --baseline .secrets.baseline
          fi

      - name: Scan for secrets
        run: |
          detect-secrets scan --baseline .secrets.baseline

      - name: Audit secrets
        run: |
          detect-secrets audit .secrets.baseline

      - name: Upload detect-secrets baseline
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: secrets-baseline
          path: .secrets.baseline

  # ============================================================================
  # Job 4: Secret Scan Summary
  # ============================================================================
  summary:
    name: Secret Scanning Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, detect-secrets]
    if: always()

    steps:
      - name: Check scan results
        run: |
          echo "=================================================="
          echo "Secret Scanning Summary"
          echo "=================================================="
          echo ""

          if [ "${{ needs.gitleaks.result }}" == "success" ]; then
            echo "‚úÖ Gitleaks: PASSED"
          else
            echo "‚ùå Gitleaks: FAILED - Secrets detected!"
          fi

          if [ "${{ needs.trufflehog.result }}" == "success" ]; then
            echo "‚úÖ TruffleHog: PASSED"
          else
            echo "‚ùå TruffleHog: FAILED - Secrets detected!"
          fi

          if [ "${{ needs.detect-secrets.result }}" == "success" ]; then
            echo "‚úÖ detect-secrets: PASSED"
          else
            echo "‚ùå detect-secrets: FAILED - Secrets detected!"
          fi

          echo ""
          echo "=================================================="

          # Fail if any scanner failed
          if [ "${{ needs.gitleaks.result }}" != "success" ] || \
             [ "${{ needs.trufflehog.result }}" != "success" ] || \
             [ "${{ needs.detect-secrets.result }}" != "success" ]; then
            echo "‚ùå SECRET SCANNING FAILED - Secrets detected in repository!"
            echo ""
            echo "Action required:"
            echo "1. Review the scan results above"
            echo "2. Remove any exposed secrets immediately"
            echo "3. Rotate all compromised credentials"
            echo "4. Update .gitleaks.toml allowlist if false positive"
            exit 1
          fi

          echo "‚úÖ All secret scans passed!"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const gitleaks = '${{ needs.gitleaks.result }}';
            const trufflehog = '${{ needs.trufflehog.result }}';
            const detectSecrets = '${{ needs.detect-secrets.result }}';

            let emoji = '‚úÖ';
            let status = 'PASSED';
            let urgency = '';

            if (gitleaks !== 'success' || trufflehog !== 'success' || detectSecrets !== 'success') {
              emoji = 'üö®';
              status = 'FAILED';
              urgency = '\n\n**‚ö†Ô∏è URGENT: Secrets detected in this PR! Do NOT merge until resolved.**';
            }

            const comment = `## ${emoji} Secret Scanning ${status}

            | Scanner | Status |
            |---------|--------|
            | Gitleaks | ${gitleaks === 'success' ? '‚úÖ Passed' : '‚ùå Failed - Secrets detected!'} |
            | TruffleHog | ${trufflehog === 'success' ? '‚úÖ Passed' : '‚ùå Failed - Secrets detected!'} |
            | detect-secrets | ${detectSecrets === 'success' ? '‚úÖ Passed' : '‚ùå Failed - Secrets detected!'} |
            ${urgency}

            ${status === 'FAILED' ? `
            ### Required Actions

            1. **Remove secrets immediately** from all commits
            2. **Rotate compromised credentials** (API keys, passwords, tokens)
            3. **Use environment variables** or secrets management (Vault)
            4. **Review** \`.gitleaks.toml\` allowlist for false positives
            5. **Re-run scans** after fixes

            ### Resources

            - [Secret Scanning Documentation](../docs/security/secret-scanning.md)
            - [Gitleaks Configuration](.gitleaks.toml)
            - [How to Remove Secrets from Git History](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository)
            ` : '**No secrets detected in this PR.**'}

            ---
            <sub>Secret scanning powered by Gitleaks + TruffleHog + detect-secrets</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail workflow if secrets detected
        if: |
          needs.gitleaks.result != 'success' ||
          needs.trufflehog.result != 'success' ||
          needs.detect-secrets.result != 'success'
        run: |
          echo "‚ùå Workflow failed due to secret detection"
          exit 1
