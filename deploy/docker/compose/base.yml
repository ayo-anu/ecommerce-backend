


networks:
  public_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  backend_network:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.21.0.0/24
  ai_network:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.22.0.0/24
  monitoring_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/24

volumes:
  postgres_data:
  postgres_ai_data:
  redis_data:
  elasticsearch_data:
  qdrant_data:
  prometheus_data:
  grafana_data:
  backend_media:
  backend_static:

services:
  postgres:
    image: postgres:15-alpine
    container_name: ecommerce_postgres
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-ecommerce}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8"
    ports:
      - "5432:5432"
    networks:
      - backend_network
      - monitoring_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres_ai:
    image: postgres:15-alpine
    container_name: ecommerce_postgres_ai
    restart: unless-stopped
    volumes:
      - postgres_ai_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${POSTGRES_AI_DB:-ecommerce_ai}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "5433:5432"
    networks:
      - ai_network
      - monitoring_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgbouncer:
    build:
      context: ../../../infrastructure/docker/pgbouncer
      dockerfile: Dockerfile
    container_name: ecommerce_pgbouncer
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/ecommerce
    ports:
      - "6432:6432"
    networks:
      - backend_network
    depends_on:
      postgres:
        condition: service_healthy
      postgres_ai:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "psql -h localhost -p 6432 -U postgres -d pgbouncer -c 'SHOW STATS' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: ecommerce_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - backend_network
      - ai_network
      - monitoring_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: ecommerce_elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - backend_network
      - monitoring_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  qdrant:
    build:
      context: ../../../infrastructure/docker/qdrant
      dockerfile: Dockerfile
    image: ecommerce_qdrant:latest
    container_name: ecommerce_qdrant
    restart: unless-stopped
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"
    networks:
      - ai_network
      - monitoring_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ../../../services/backend
      dockerfile: Dockerfile
    container_name: ecommerce_backend
    restart: unless-stopped
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4 --timeout 120
    volumes:
      - ../../../services/backend:/app
      - backend_media:/app/media
      - backend_static:/app/staticfiles
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-ecommerce}
      - DB_ENGINE=django.db.backends.postgresql
      - DB_NAME=${POSTGRES_DB:-ecommerce}
      - DB_USER=${POSTGRES_USER:-postgres}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/1
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - SECRET_KEY=${SECRET_KEY:-django-insecure-dev-key-change-in-production}
      - DEBUG=${DEBUG:-True}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1,backend,api_gateway}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_STORAGE_BUCKET_NAME=${AWS_STORAGE_BUCKET_NAME}
      - SENTRY_DSN=${SENTRY_DSN}
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - OTEL_SERVICE_NAME=ecommerce-backend
      - OTEL_TRACES_EXPORTER=jaeger
    ports:
      - "8000:8000"
    networks:
      - backend_network
      - monitoring_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3

  celery_worker:
    build:
      context: ../../../services/backend
      dockerfile: Dockerfile
    container_name: ecommerce_celery_worker
    restart: unless-stopped
    command: celery -A config worker -l info --concurrency=4
    volumes:
      - ../../../services/backend:/app
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-ecommerce}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/1
      - SECRET_KEY=${SECRET_KEY:-django-insecure-dev-key-change-in-production}
    networks:
      - backend_network
      - monitoring_network
    depends_on:
      - backend
      - redis
    healthcheck:
      test: ["CMD-SHELL", "celery -A config inspect ping -d celery@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  celery_beat:
    build:
      context: ../../../services/backend
      dockerfile: Dockerfile
    container_name: ecommerce_celery_beat
    restart: unless-stopped
    command: celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - ../../../services/backend:/app
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-ecommerce}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/1
      - SECRET_KEY=${SECRET_KEY:-django-insecure-dev-key-change-in-production}
    networks:
      - backend_network
      - monitoring_network
    depends_on:
      - backend
      - redis
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'celery beat' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  api_gateway:
    build:
      context: ../../../services
      dockerfile: gateway/Dockerfile
    container_name: ecommerce_api_gateway
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8080 --workers 4
    volumes:
      - ../../../services/gateway:/app
      - ../../../services/shared:/app/shared
    environment:
      - BACKEND_URL=http://backend:8000
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/2
      - QDRANT_URL=http://qdrant:6333
      - RECOMMENDER_URL=http://recommender:8001
      - SEARCH_URL=http://search:8002
      - PRICING_URL=http://pricing:8003
      - CHATBOT_URL=http://chatbot:8004
      - FRAUD_URL=http://fraud:8005
      - FORECASTING_URL=http://forecasting:8006
      - VISION_URL=http://vision:8007
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - OTEL_SERVICE_NAME=api-gateway
      - OTEL_TRACES_EXPORTER=jaeger
    ports:
      - "8080:8080"
    networks:
      - public_network
      - backend_network
      - ai_network
      - monitoring_network
    depends_on:
      - redis
      - qdrant
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  recommender:
    build:
      context: ../../../services
      dockerfile: ai/services/recommendation_engine/Dockerfile
    container_name: ecommerce_recommender
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8001
    volumes:
      - ../../../services/ai/services/recommendation_engine:/app
      - ../../../services/shared:/app/shared
      - ../../../services/ai/models:/models
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres_ai:5432/${POSTGRES_AI_DB:-ecommerce_ai}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/3
      - MODEL_PATH=/models/recommendation
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8001:8001"
    networks:
      - ai_network
      - monitoring_network
    depends_on:
      postgres_ai:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  search:
    build:
      context: ../../../services
      dockerfile: ai/services/search_engine/Dockerfile
    container_name: ecommerce_search
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8002
    volumes:
      - ../../../services/ai/services/search_engine:/app
      - ../../../services/shared:/app/shared
      - ../../../services/ai/models:/models
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres_ai:5432/${POSTGRES_AI_DB:-ecommerce_ai}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/4
      - QDRANT_URL=http://qdrant:6333
      - MODEL_PATH=/models/search
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8002:8002"
    networks:
      - ai_network
      - monitoring_network
    depends_on:
      postgres_ai:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  pricing:
    build:
      context: ../../../services
      dockerfile: ai/services/pricing_engine/Dockerfile
    container_name: ecommerce_pricing
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8003
    volumes:
      - ../../../services/ai/services/pricing_engine:/app
      - ../../../services/shared:/app/shared
      - ../../../services/ai/models:/models
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres_ai:5432/${POSTGRES_AI_DB:-ecommerce_ai}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/5
      - MODEL_PATH=/models/pricing
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8003:8003"
    networks:
      - ai_network
      - monitoring_network
    depends_on:
      postgres_ai:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  chatbot:
    build:
      context: ../../../services
      dockerfile: ai/services/chatbot_rag/Dockerfile
    container_name: ecommerce_chatbot
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8004
    volumes:
      - ../../../services/ai/services/chatbot_rag:/app
      - ../../../services/shared:/app/shared
      - ../../../services/ai/models:/models
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres_ai:5432/${POSTGRES_AI_DB:-ecommerce_ai}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/6
      - QDRANT_URL=http://qdrant:6333
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MODEL_PATH=/models/chatbot
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8004:8004"
    networks:
      - ai_network
      - monitoring_network
    depends_on:
      postgres_ai:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  fraud:
    build:
      context: ../../../services
      dockerfile: ai/services/fraud_detection/Dockerfile
    container_name: ecommerce_fraud
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8005
    volumes:
      - ../../../services/ai/services/fraud_detection:/app
      - ../../../services/shared:/app/shared
      - ../../../services/ai/models:/models
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres_ai:5432/${POSTGRES_AI_DB:-ecommerce_ai}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/7
      - MODEL_PATH=/models/fraud
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8005:8005"
    networks:
      - ai_network
      - monitoring_network
    depends_on:
      postgres_ai:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  forecasting:
    build:
      context: ../../../services
      dockerfile: ai/services/demand_forecasting/Dockerfile
    container_name: ecommerce_forecasting
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8006
    volumes:
      - ../../../services/ai/services/demand_forecasting:/app
      - ../../../services/shared:/app/shared
      - ../../../services/ai/models:/models
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres_ai:5432/${POSTGRES_AI_DB:-ecommerce_ai}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/8
      - MODEL_PATH=/models/forecasting
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8006:8006"
    networks:
      - ai_network
      - monitoring_network
    depends_on:
      postgres_ai:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  vision:
    build:
      context: ../../../services
      dockerfile: ai/services/visual_recognition/Dockerfile
    container_name: ecommerce_vision
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8007
    volumes:
      - ../../../services/ai/services/visual_recognition:/app
      - ../../../services/shared:/app/shared
      - ../../../services/ai/models:/models
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres_ai:5432/${POSTGRES_AI_DB:-ecommerce_ai}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/9
      - QDRANT_URL=http://qdrant:6333
      - MODEL_PATH=/models/vision
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8007:8007"
    networks:
      - ai_network
      - monitoring_network
    depends_on:
      postgres_ai:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    container_name: ecommerce_prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ../monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ../monitoring/prometheus/alerts:/etc/prometheus/alerts
      - ../monitoring/prometheus/recording_rules:/etc/prometheus/recording_rules
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - monitoring_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  grafana:
    image: grafana/grafana:latest
    container_name: ecommerce_grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
      - POSTGRES_DB=${POSTGRES_DB:-ecommerce}
      - POSTGRES_AI_DB=${POSTGRES_AI_DB:-ecommerce_ai}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    volumes:
      - grafana_data:/var/lib/grafana
      - ../../../monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ../../../monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ../../../monitoring/grafana/dashboards:/etc/grafana/dashboards
    ports:
      - "3001:3000"
    networks:
      - monitoring_network
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: ecommerce_jaeger
    restart: unless-stopped
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686"
      - "6831:6831/udp"
      - "14268:14268"
      - "4317:4317"
      - "4318:4318"
    networks:
      - monitoring_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
      interval: 30s
      timeout: 10s
      retries: 3
