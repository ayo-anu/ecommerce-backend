
# ==============================================================================
# E-Commerce Platform - PRODUCTION Override
# ==============================================================================
# This file secures the platform for production deployment.
#
# USAGE:
#   docker-compose -f docker-compose.yaml -f docker-compose.prod.yaml up -d
#
# SECURITY ENHANCEMENTS:
#   ✓ NO exposed ports except Nginx (80, 443)
#   ✓ Internal networks isolated from public access
#   ✓ Production environment variables
#   ✓ Resource limits for stability
#   ✓ Automatic restart policies
#   ✓ Security headers via Nginx
#
# ARCHITECTURE:
#   Client → Nginx (public) → API Gateway (internal) → Backend + AI Services
# ==============================================================================

services:
  # ============================================================================
  # SECURITY: Remove all port exposures (services are internal-only)
  # ============================================================================

  # Database services - NO external access
  postgres:
    ports: []
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}  # Must be set in production
    networks:
      - database    # Database tier only
      - monitoring  # For metrics collection
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
          pids: 500
        reservations:
          cpus: '1'
          memory: 1G
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 8192
    security_opt:
      - no-new-privileges:true
    shm_size: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres"

  postgres_ai:
    ports: []
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - database    # Database tier only
      - monitoring  # For metrics collection
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
          pids: 500
        reservations:
          cpus: '1'
          memory: 1G
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 8192
    security_opt:
      - no-new-privileges:true
    shm_size: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres_ai"

  pgbouncer:
    ports: []
    restart: always
    networks:
      - database    # Connects to databases
      - application # Backend services connect here
      - monitoring  # For metrics collection
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=pgbouncer"

  # Cache & queue services - NO external access
  redis:
    ports: []
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 1gb --maxmemory-policy allkeys-lru
    networks:
      - database    # Shared cache/queue tier
      - application # Application services access
      - monitoring  # For metrics collection
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
          pids: 100
        reservations:
          cpus: '0.5'
          memory: 512M
    ulimits:
      nofile:
        soft: 10240
        hard: 10240
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=redis"

  elasticsearch:
    ports: []
    restart: always
    environment:
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    networks:
      - database    # Database tier
      - application # Backend search access
      - monitoring  # For metrics collection
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=elasticsearch"

  qdrant:
    ports: []
    restart: always
    networks:
      - database    # Vector database tier
      - application # AI services access
      - monitoring  # For metrics collection
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=qdrant"

  rabbitmq:
    ports: []
    restart: always
    networks:
      - database    # Message queue tier
      - application # Services publish/consume
      - monitoring  # For metrics collection
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=rabbitmq"

  # Backend services - NO external access (only via API Gateway)
  backend:
    ports: []
    restart: always
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 8 --threads 4 --timeout 120 --max-requests 1000 --max-requests-jitter 50
    environment:
      - DEBUG=False
      - ENVIRONMENT=production
      - SECRET_KEY=${SECRET_KEY}  # MUST be set in production
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}  # e.g., yourdomain.com,api.yourdomain.com
      - SECURE_SSL_REDIRECT=True
      - SESSION_COOKIE_SECURE=True
      - CSRF_COOKIE_SECURE=True
      - SECURE_BROWSER_XSS_FILTER=True
      - SECURE_CONTENT_TYPE_NOSNIFF=True
      - SECURE_HSTS_SECONDS=31536000
      - SECURE_HSTS_INCLUDE_SUBDOMAINS=True
      - SECURE_HSTS_PRELOAD=True
    networks:
      - application # Application tier
      - database    # Access to databases
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
          pids: 500
        reservations:
          cpus: '2'
          memory: 2G
    ulimits:
      nofile:
        soft: 16384
        hard: 16384
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=backend"

  celery_worker:
    restart: always
    command: celery -A config worker -l warning --concurrency=8 --max-tasks-per-child=1000
    environment:
      - ENVIRONMENT=production
    networks:
      - application # Application tier
      - database    # Access to databases and queues
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=celery_worker"

  celery_beat:
    restart: always
    environment:
      - ENVIRONMENT=production
    networks:
      - application # Application tier
      - database    # Access to databases and queues
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=celery_beat"

  # API Gateway - NO external access (only via Nginx)
  api_gateway:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8080 --workers 8 --loop uvloop --no-access-log
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=WARNING
    networks:
      - application # Application tier - communicates with all services
      - database    # Access to cache/queue
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
          pids: 500
        reservations:
          cpus: '2'
          memory: 2G
    ulimits:
      nofile:
        soft: 16384
        hard: 16384
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=api_gateway"

  # AI Services - NO external access
  recommender:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application # Application tier
      - database    # Access to AI databases
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=recommender"

  search:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8002 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application # Application tier
      - database    # Access to AI databases
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=search"

  pricing:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8003 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application # Application tier
      - database    # Access to AI databases
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=pricing"

  chatbot:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8004 --workers 2 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application # Application tier
      - database    # Access to AI databases
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=chatbot"

  fraud:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8005 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application # Application tier
      - database    # Access to AI databases
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=fraud"

  forecasting:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8006 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application # Application tier
      - database    # Access to AI databases
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=forecasting"

  vision:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8007 --workers 2 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application # Application tier
      - database    # Access to AI databases
      - monitoring  # Expose metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=vision"

  # Monitoring services - NO external access (internal monitoring only)
  prometheus:
    ports: []
    restart: always
    networks:
      - monitoring  # Collects metrics from all services
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=prometheus"

  grafana:
    ports: []
    restart: always
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}  # MUST be set in production
      - GF_SERVER_ROOT_URL=https://${DOMAIN}/grafana
      - GF_ANALYTICS_REPORTING_ENABLED=false
    networks:
      - monitoring  # Access to Prometheus and other data sources
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=grafana"

  jaeger:
    ports: []
    restart: always
    networks:
      - monitoring  # Collects traces from all services
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=jaeger"

  # ============================================================================
  # NGINX - THE ONLY PUBLIC-FACING SERVICE
  # ============================================================================
  # This is the ONLY service with exposed ports in production
  # All traffic flows: Client → Nginx → API Gateway → Internal Services
  # ============================================================================

  nginx:
    image: nginx:alpine
    container_name: ecommerce_nginx
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - backend_static:/var/www/static:ro
      - backend_media:/var/www/media:ro
    ports:
      - "80:80"      # HTTP (redirects to HTTPS)
      - "443:443"    # HTTPS (secure traffic only)
    networks:
      - frontend      # Public-facing network
      - application   # To communicate with API Gateway
      - monitoring    # For metrics exposure
    depends_on:
      - api_gateway
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
          pids: 100
        reservations:
          cpus: '1'
          memory: 512M
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=nginx"

# ==============================================================================
# PRODUCTION NETWORKS - 3-Tier Architecture
# ==============================================================================
# Network segmentation for enhanced security:
# - Frontend: Public-facing (nginx only)
# - Application: Internal services (API gateway, backend, AI services)
# - Database: Database tier (postgres, redis, etc.)
# - Monitoring: Observability services (prometheus, grafana, jaeger)
# ==============================================================================

networks:
  # Frontend network - ONLY nginx can access, connected to external
  frontend:
    driver: bridge
    internal: false  # Connected to external for public access
    ipam:
      config:
        - subnet: 172.20.0.0/24

  # Application network - Backend services, no external access
  application:
    driver: bridge
    internal: true  # No external connectivity
    ipam:
      config:
        - subnet: 172.21.0.0/24

  # Database network - Database tier only, no external access
  database:
    driver: bridge
    internal: true  # No external connectivity
    ipam:
      config:
        - subnet: 172.22.0.0/24

  # Monitoring network - Cross-cutting for metrics collection
  monitoring:
    driver: bridge
    internal: true  # No external connectivity
    ipam:
      config:
        - subnet: 172.23.0.0/24

# ==============================================================================
# IMPORTANT PRODUCTION CHECKLIST
# ==============================================================================
# Before deploying:
#
# 1. ENVIRONMENT VARIABLES (create .env.prod file):
#    - SECRET_KEY=<strong-random-key>
#    - POSTGRES_PASSWORD=<strong-db-password>
#    - REDIS_PASSWORD=<strong-redis-password>
#    - ALLOWED_HOSTS=yourdomain.com,api.yourdomain.com
#    - GRAFANA_PASSWORD=<strong-grafana-password>
#    - DOMAIN=yourdomain.com
#    - STRIPE_SECRET_KEY=<your-stripe-key>
#    - AWS_ACCESS_KEY_ID=<your-aws-key>
#    - AWS_SECRET_ACCESS_KEY=<your-aws-secret>
#    - SENTRY_DSN=<your-sentry-dsn>
#    - OPENAI_API_KEY=<your-openai-key>
#
# 2. SSL CERTIFICATES:
#    - Place SSL certs in: ./nginx/ssl/
#    - Required files: fullchain.pem, privkey.pem
#    - Use Let's Encrypt or your certificate provider
#
# 3. DNS CONFIGURATION:
#    - Point your domain to server IP
#    - Configure A records for api.yourdomain.com
#
# 4. FIREWALL:
#    - Open ports: 80, 443
#    - Close all other ports
#    - Configure security groups (AWS) or firewall rules
#
# 5. BACKUP STRATEGY:
#    - Set up automated backups for volumes
#    - postgres_data, postgres_ai_data, redis_data
#
# 6. MONITORING:
#    - Configure external monitoring (Datadog, New Relic, etc.)
#    - Set up alerting for critical errors
#    - Monitor disk space, CPU, memory
#
# 7. DEPLOYMENT:
#    docker-compose -f docker-compose.yaml -f docker-compose.prod.yaml up -d
#
# ==============================================================================
