

services:
  postgres:
    ports: []
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
          pids: 500
        reservations:
          cpus: '1'
          memory: 1G
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 8192
    security_opt:
      - no-new-privileges:true
    shm_size: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres"

  postgres_ai:
    ports: []
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
          pids: 500
        reservations:
          cpus: '1'
          memory: 1G
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 8192
    security_opt:
      - no-new-privileges:true
    shm_size: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres_ai"

  pgbouncer:
    ports: []
    restart: always
    networks:
      - database
      - application
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=pgbouncer"

  redis:
    ports: []
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 1gb --maxmemory-policy allkeys-lru
    networks:
      - database
      - application
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
          pids: 100
        reservations:
          cpus: '0.5'
          memory: 512M
    ulimits:
      nofile:
        soft: 10240
        hard: 10240
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=redis"

  elasticsearch:
    ports: []
    restart: always
    environment:
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    networks:
      - database
      - application
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=elasticsearch"

  qdrant:
    ports: []
    restart: always
    networks:
      - database
      - application
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=qdrant"

  rabbitmq:
    ports: []
    restart: always
    networks:
      - database
      - application
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=rabbitmq"

  backend:
    ports: []
    restart: always
    user: "1000:1000"
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 8 --threads 4 --timeout 120 --max-requests 1000 --max-requests-jitter 50
    environment:
      - DEBUG=False
      - ENVIRONMENT=production
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - SECURE_SSL_REDIRECT=True
      - SESSION_COOKIE_SECURE=True
      - CSRF_COOKIE_SECURE=True
      - SECURE_BROWSER_XSS_FILTER=True
      - SECURE_CONTENT_TYPE_NOSNIFF=True
      - SECURE_HSTS_SECONDS=31536000
      - SECURE_HSTS_INCLUDE_SUBDOMAINS=True
      - SECURE_HSTS_PRELOAD=True
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - OTEL_SERVICE_NAME=ecommerce-backend
      - OTEL_TRACES_EXPORTER=jaeger
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
          pids: 500
        reservations:
          cpus: '2'
          memory: 2G
    ulimits:
      nofile:
        soft: 16384
        hard: 16384
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=backend"

  celery_worker:
    restart: always
    user: "1000:1000"
    command: celery -A config worker -l warning --concurrency=8 --max-tasks-per-child=1000
    environment:
      - ENVIRONMENT=production
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=celery_worker"

  celery_beat:
    restart: always
    user: "1000:1000"
    environment:
      - ENVIRONMENT=production
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=celery_beat"

  api_gateway:
    ports: []
    restart: always
    user: "1000:1000"
    command: uvicorn main:app --host 0.0.0.0 --port 8080 --workers 8 --loop uvloop --no-access-log
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=WARNING
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - OTEL_SERVICE_NAME=api-gateway
      - OTEL_TRACES_EXPORTER=jaeger
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
          pids: 500
        reservations:
          cpus: '2'
          memory: 2G
    ulimits:
      nofile:
        soft: 16384
        hard: 16384
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=api_gateway"

  recommender:
    ports: []
    restart: always
    user: "1001:1001"
    command: uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=recommender"

  search:
    ports: []
    restart: always
    user: "1001:1001"
    command: uvicorn main:app --host 0.0.0.0 --port 8002 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=search"

  pricing:
    ports: []
    restart: always
    user: "1001:1001"
    command: uvicorn main:app --host 0.0.0.0 --port 8003 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=pricing"

  chatbot:
    ports: []
    restart: always
    user: "1001:1001"
    command: uvicorn main:app --host 0.0.0.0 --port 8004 --workers 2 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=chatbot"

  fraud:
    ports: []
    restart: always
    user: "1001:1001"
    command: uvicorn main:app --host 0.0.0.0 --port 8005 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=fraud"

  forecasting:
    ports: []
    restart: always
    user: "1001:1001"
    command: uvicorn main:app --host 0.0.0.0 --port 8006 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=forecasting"

  vision:
    ports: []
    restart: always
    user: "1001:1001"
    command: uvicorn main:app --host 0.0.0.0 --port 8007 --workers 2 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    networks:
      - application
      - database
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=vision"

  prometheus:
    ports: []
    restart: always
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=prometheus"

  grafana:
    ports: []
    restart: always
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_SERVER_ROOT_URL=https://${DOMAIN}/grafana
      - GF_ANALYTICS_REPORTING_ENABLED=false
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=grafana"

  jaeger:
    ports: []
    restart: always
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=jaeger"


  nginx:
    image: nginx:alpine
    container_name: ecommerce_nginx
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - backend_static:/var/www/static:ro
      - backend_media:/var/www/media:ro
    ports:
      - "80:80"
      - "443:443"
    networks:
      - frontend
      - application
      - monitoring
    depends_on:
      - api_gateway
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
          pids: 100
        reservations:
          cpus: '1'
          memory: 512M
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=nginx"


networks:
  frontend:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.20.0.0/24

  application:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/24

  database:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.22.0.0/24

  monitoring:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.23.0.0/24
