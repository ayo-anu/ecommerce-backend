
services:
  vault:
    image: hashicorp/vault:1.15
    container_name: ecommerce_vault
    restart: always

    ports:
      - "8200:8200"

    environment:
      - VAULT_ADDR=http://0.0.0.0:8200
      - VAULT_API_ADDR=http://0.0.0.0:8200
      - VAULT_LOCAL_CONFIG=${VAULT_LOCAL_CONFIG:-}

      - SKIP_SETCAP=true

    volumes:
      - vault_data:/vault/data

      - vault_logs:/vault/logs

      - ../../vault/config:/vault/config:ro

      - ../../vault/policies:/vault/policies:ro

    cap_add:
      - IPC_LOCK

    command: server

    networks:
      - application
      - database
      - monitoring

    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
          pids: 100
        reservations:
          cpus: '0.5'
          memory: 256M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=vault"

volumes:
  vault_data:
    driver: local
    name: ecommerce_vault_data

  vault_logs:
    driver: local
    name: ecommerce_vault_logs

