# ==============================================================================
# Upstream Configuration - Blue-Green Deployment Support
# ==============================================================================
# This file defines upstream servers for blue-green deployments.
# Switch between blue and green by updating the 'backend' upstream.
# ==============================================================================

# ==============================================================================
# API Gateway Upstreams (Blue-Green)
# ==============================================================================

# Blue environment (active by default)
upstream api_gateway_blue {
    least_conn;
    keepalive 32;

    server api_gateway:8080 max_fails=3 fail_timeout=30s;

    # Health check (requires nginx plus or use backup servers)
    # health_check interval=10s fails=3 passes=2 uri=/health;
}

# Green environment (for deployments)
upstream api_gateway_green {
    least_conn;
    keepalive 32;

    # Initially points to same server, switch during deployment
    server api_gateway:8080 max_fails=3 fail_timeout=30s;

    # Uncomment and configure when deploying new version
    # server api_gateway_green:8080 max_fails=3 fail_timeout=30s;
}

# Active upstream (switch between blue/green here)
upstream api_gateway {
    least_conn;
    keepalive 32;

    # DEPLOYMENT: Comment/uncomment to switch between blue and green
    server api_gateway:8080 max_fails=3 fail_timeout=30s;  # ACTIVE: blue
    # server api_gateway_green:8080 max_fails=3 fail_timeout=30s;  # ACTIVE: green
}

# ==============================================================================
# Backend Service Upstreams (Blue-Green)
# ==============================================================================

# Blue environment
upstream backend_blue {
    least_conn;
    keepalive 32;

    server backend:8000 max_fails=3 fail_timeout=30s;
}

# Green environment
upstream backend_green {
    least_conn;
    keepalive 32;

    server backend:8000 max_fails=3 fail_timeout=30s;
    # server backend_green:8000 max_fails=3 fail_timeout=30s;  # Uncomment for green
}

# Active upstream
upstream backend {
    least_conn;
    keepalive 32;

    # DEPLOYMENT: Switch between blue and green
    server backend:8000 max_fails=3 fail_timeout=30s;  # ACTIVE: blue
}

# ==============================================================================
# Monitoring Services
# ==============================================================================

upstream prometheus {
    server prometheus:9090 max_fails=3 fail_timeout=30s;
}

upstream grafana {
    server grafana:3000 max_fails=3 fail_timeout=30s;
}

upstream jaeger {
    server jaeger:16686 max_fails=3 fail_timeout=30s;
}

# ==============================================================================
# Upstream Configuration Notes
# ==============================================================================
#
# Blue-Green Deployment Process:
#
# 1. Deploy new version to green environment
# 2. Verify green is healthy (check /health endpoints)
# 3. Switch traffic to green by updating 'api_gateway' upstream
# 4. Monitor for errors
# 5. If issues, quickly switch back to blue
# 6. Once stable, blue becomes the new green for next deployment
#
# Example deployment script:
#   1. Start api_gateway_green container
#   2. Wait for health checks to pass
#   3. Update this file to switch to green
#   4. Reload nginx: docker exec nginx nginx -s reload
#   5. Monitor logs and metrics
#   6. If stable, stop blue; if issues, switch back to blue
#
# ==============================================================================
