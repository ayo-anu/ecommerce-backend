
# ==============================================================================
# E-Commerce Platform - PRODUCTION Override
# ==============================================================================
# This file secures the platform for production deployment.
#
# USAGE:
#   docker-compose -f docker-compose.yaml -f docker-compose.prod.yaml up -d
#
# SECURITY ENHANCEMENTS:
#   ✓ NO exposed ports except Nginx (80, 443)
#   ✓ Internal networks isolated from public access
#   ✓ Production environment variables
#   ✓ Resource limits for stability
#   ✓ Automatic restart policies
#   ✓ Security headers via Nginx
#
# ARCHITECTURE:
#   Client → Nginx (public) → API Gateway (internal) → Backend + AI Services
# ==============================================================================

services:
  # ============================================================================
  # SECURITY: Remove all port exposures (services are internal-only)
  # ============================================================================

  # Database services - NO external access
  postgres:
    ports: []
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}  # Must be set in production
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  postgres_ai:
    ports: []
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  pgbouncer:
    ports: []
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # Cache & queue services - NO external access
  redis:
    ports: []
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 1gb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  elasticsearch:
    ports: []
    restart: always
    environment:
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  qdrant:
    ports: []
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  rabbitmq:
    ports: []
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Backend services - NO external access (only via API Gateway)
  backend:
    ports: []
    restart: always
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 8 --threads 4 --timeout 120 --max-requests 1000 --max-requests-jitter 50
    environment:
      - DEBUG=False
      - ENVIRONMENT=production
      - SECRET_KEY=${SECRET_KEY}  # MUST be set in production
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}  # e.g., yourdomain.com,api.yourdomain.com
      - SECURE_SSL_REDIRECT=True
      - SESSION_COOKIE_SECURE=True
      - CSRF_COOKIE_SECURE=True
      - SECURE_BROWSER_XSS_FILTER=True
      - SECURE_CONTENT_TYPE_NOSNIFF=True
      - SECURE_HSTS_SECONDS=31536000
      - SECURE_HSTS_INCLUDE_SUBDOMAINS=True
      - SECURE_HSTS_PRELOAD=True
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G

  celery_worker:
    restart: always
    command: celery -A config worker -l warning --concurrency=8 --max-tasks-per-child=1000
    environment:
      - ENVIRONMENT=production
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  celery_beat:
    restart: always
    environment:
      - ENVIRONMENT=production
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # API Gateway - NO external access (only via Nginx)
  api_gateway:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8080 --workers 8 --loop uvloop --no-access-log
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G

  # AI Services - NO external access
  recommender:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  search:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8002 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  pricing:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8003 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  chatbot:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8004 --workers 2 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 2G

  fraud:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8005 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  forecasting:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8006 --workers 4 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  vision:
    ports: []
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8007 --workers 2 --loop uvloop --no-access-log
    environment:
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 2G

  # Monitoring services - NO external access (internal monitoring only)
  prometheus:
    ports: []
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  grafana:
    ports: []
    restart: always
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}  # MUST be set in production
      - GF_SERVER_ROOT_URL=https://${DOMAIN}/grafana
      - GF_ANALYTICS_REPORTING_ENABLED=false
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  jaeger:
    ports: []
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ============================================================================
  # NGINX - THE ONLY PUBLIC-FACING SERVICE
  # ============================================================================
  # This is the ONLY service with exposed ports in production
  # All traffic flows: Client → Nginx → API Gateway → Internal Services
  # ============================================================================

  nginx:
    image: nginx:alpine
    container_name: ecommerce_nginx
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - backend_static:/var/www/static:ro
      - backend_media:/var/www/media:ro
    ports:
      - "80:80"      # HTTP (redirects to HTTPS)
      - "443:443"    # HTTPS (secure traffic only)
    networks:
      - public_network  # Can ONLY communicate with API Gateway
    depends_on:
      - api_gateway
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M

# ==============================================================================
# PRODUCTION NETWORKS
# ==============================================================================
# Make internal networks truly isolated
# ==============================================================================

networks:
  # Internal networks should be isolated (no external routing)
  backend_network:
    internal: true  # No external connectivity
  ai_network:
    internal: true  # No external connectivity

# ==============================================================================
# IMPORTANT PRODUCTION CHECKLIST
# ==============================================================================
# Before deploying:
#
# 1. ENVIRONMENT VARIABLES (create .env.prod file):
#    - SECRET_KEY=<strong-random-key>
#    - POSTGRES_PASSWORD=<strong-db-password>
#    - REDIS_PASSWORD=<strong-redis-password>
#    - ALLOWED_HOSTS=yourdomain.com,api.yourdomain.com
#    - GRAFANA_PASSWORD=<strong-grafana-password>
#    - DOMAIN=yourdomain.com
#    - STRIPE_SECRET_KEY=<your-stripe-key>
#    - AWS_ACCESS_KEY_ID=<your-aws-key>
#    - AWS_SECRET_ACCESS_KEY=<your-aws-secret>
#    - SENTRY_DSN=<your-sentry-dsn>
#    - OPENAI_API_KEY=<your-openai-key>
#
# 2. SSL CERTIFICATES:
#    - Place SSL certs in: ./nginx/ssl/
#    - Required files: fullchain.pem, privkey.pem
#    - Use Let's Encrypt or your certificate provider
#
# 3. DNS CONFIGURATION:
#    - Point your domain to server IP
#    - Configure A records for api.yourdomain.com
#
# 4. FIREWALL:
#    - Open ports: 80, 443
#    - Close all other ports
#    - Configure security groups (AWS) or firewall rules
#
# 5. BACKUP STRATEGY:
#    - Set up automated backups for volumes
#    - postgres_data, postgres_ai_data, redis_data
#
# 6. MONITORING:
#    - Configure external monitoring (Datadog, New Relic, etc.)
#    - Set up alerting for critical errors
#    - Monitor disk space, CPU, memory
#
# 7. DEPLOYMENT:
#    docker-compose -f docker-compose.yaml -f docker-compose.prod.yaml up -d
#
# ==============================================================================
