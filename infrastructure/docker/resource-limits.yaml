# ==============================================================================
# Docker Resource Limits for All Services
# Enterprise-Grade Production Configuration
# ==============================================================================
# Usage: Include this file in docker-compose.yml with:
#   include:
#     - infrastructure/docker/resource-limits.yaml
# ==============================================================================

version: '3.8'

# ==============================================================================
# Small Services (API endpoints, lightweight services)
# CPU: 0.5 cores, Memory: 512MB
# ==============================================================================
x-resource-limits-small: &resource-limits-small
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
        pids: 100
      reservations:
        cpus: '0.25'
        memory: 256M
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  ulimits:
    nofile:
      soft: 4096
      hard: 8192
  security_opt:
    - no-new-privileges:true
  read_only: false

# ==============================================================================
# Medium Services (Backend API, AI Gateway, Application Services)
# CPU: 1.0 cores, Memory: 1GB
# ==============================================================================
x-resource-limits-medium: &resource-limits-medium
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
        pids: 200
      reservations:
        cpus: '0.5'
        memory: 512M
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  ulimits:
    nofile:
      soft: 8192
      hard: 16384
  security_opt:
    - no-new-privileges:true
  read_only: false

# ==============================================================================
# Large Services (Database, Redis, Heavy AI Services)
# CPU: 2.0 cores, Memory: 2GB
# ==============================================================================
x-resource-limits-large: &resource-limits-large
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 2G
        pids: 500
      reservations:
        cpus: '1.0'
        memory: 1G
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  ulimits:
    nofile:
      soft: 16384
      hard: 65536
  security_opt:
    - no-new-privileges:true
  read_only: false

# ==============================================================================
# Extra Large Services (Databases with high load, ML model servers)
# CPU: 4.0 cores, Memory: 4GB
# ==============================================================================
x-resource-limits-xlarge: &resource-limits-xlarge
  deploy:
    resources:
      limits:
        cpus: '4.0'
        memory: 4G
        pids: 1000
      reservations:
        cpus: '2.0'
        memory: 2G
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  ulimits:
    nofile:
      soft: 32768
      hard: 65536
  security_opt:
    - no-new-privileges:true
  read_only: false

# ==============================================================================
# Database-Specific Limits (PostgreSQL)
# Includes additional database-specific configurations
# ==============================================================================
x-resource-limits-postgres: &resource-limits-postgres
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 2G
        pids: 500
      reservations:
        cpus: '1.0'
        memory: 1G
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  ulimits:
    nofile:
      soft: 65536
      hard: 65536
    nproc:
      soft: 4096
      hard: 8192
  security_opt:
    - no-new-privileges:true
  read_only: false
  shm_size: 256M

# ==============================================================================
# Redis-Specific Limits
# Optimized for caching and session storage
# ==============================================================================
x-resource-limits-redis: &resource-limits-redis
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
        pids: 100
      reservations:
        cpus: '0.5'
        memory: 512M
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  ulimits:
    nofile:
      soft: 10240
      hard: 10240
  security_opt:
    - no-new-privileges:true
  read_only: false

# ==============================================================================
# Nginx-Specific Limits
# Optimized for reverse proxy and static file serving
# ==============================================================================
x-resource-limits-nginx: &resource-limits-nginx
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 256M
        pids: 100
      reservations:
        cpus: '0.25'
        memory: 128M
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  ulimits:
    nofile:
      soft: 65536
      hard: 65536
  security_opt:
    - no-new-privileges:true
  read_only: false

# ==============================================================================
# Usage Examples:
# ==============================================================================
# services:
#   backend:
#     <<: *resource-limits-medium
#     image: backend:latest
#     # ... other configurations
#
#   postgres:
#     <<: *resource-limits-postgres
#     image: postgres:15-alpine
#     # ... other configurations
#
#   redis:
#     <<: *resource-limits-redis
#     image: redis:7-alpine
#     # ... other configurations
# ==============================================================================
