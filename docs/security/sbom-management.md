# SBOM Management Guide

## Overview

This document describes the Software Bill of Materials (SBOM) management process for the E-Commerce Platform. SBOMs provide a complete inventory of all software components, libraries, and dependencies used in our container images, essential for supply chain security, vulnerability management, and compliance.

## Table of Contents

1. [What is SBOM](#what-is-sbom)
2. [Why We Generate SBOMs](#why-we-generate-sboms)
3. [SBOM Generation](#sbom-generation)
4. [SBOM Formats](#sbom-formats)
5. [Automated Generation](#automated-generation)
6. [Local Generation](#local-generation)
7. [Vulnerability Scanning](#vulnerability-scanning)
8. [DependencyTrack Integration](#dependencytrack-integration)
9. [Compliance](#compliance)
10. [Best Practices](#best-practices)

---

## What is SBOM

A Software Bill of Materials (SBOM) is a comprehensive inventory of all components in a software product, including:

- **Direct dependencies** - Libraries explicitly imported
- **Transitive dependencies** - Dependencies of dependencies
- **Operating system packages** - System libraries and tools
- **Package versions** - Exact versions of all components
- **Licenses** - License information for each component
- **Vulnerabilities** - Known security issues

### SBOM Analogy

Think of an SBOM like an ingredients list on food packaging - it tells you exactly what's inside the product.

---

## Why We Generate SBOMs

### 1. Supply Chain Security

- **Transparency**: Know exactly what's in our images
- **Vulnerability tracking**: Quickly identify affected services when vulnerabilities are disclosed
- **Third-party risk**: Understand our dependency on external components

### 2. Compliance

- **PCI-DSS**: Requirement to maintain inventory of system components
- **SOC 2**: Security control for change management
- **Executive Order 14028**: U.S. federal requirement for SBOM

### 3. Incident Response

- **Fast identification**: Quickly determine if vulnerable component is used
- **Impact assessment**: Understand scope of security issues
- **Remediation planning**: Prioritize updates based on actual usage

### 4. License Compliance

- **License tracking**: Ensure compliance with open source licenses
- **Legal risk**: Avoid incompatible license combinations
- **Attribution**: Proper credit to open source projects

---

## SBOM Generation

We generate SBOMs using multiple tools for comprehensive coverage:

### Tools Used

1. **Syft** (Primary)
   - Comprehensive package detection
   - Multiple format support
   - Fast and accurate

2. **Trivy** (Secondary)
   - Alternative SBOM generation
   - Integrated vulnerability scanning
   - Container-focused

3. **Grype** (Vulnerability Scanning)
   - Scans SBOMs for vulnerabilities
   - Comprehensive vulnerability database
   - Fast scanning

### Services Covered

SBOMs are generated for all container images:

- backend
- api-gateway
- recommendation-engine
- search-engine
- pricing-engine
- chatbot-rag
- fraud-detection
- demand-forecasting
- visual-recognition

---

## SBOM Formats

We generate SBOMs in multiple formats for different use cases:

### CycloneDX JSON

**Primary format** - Industry standard maintained by OWASP

```json
{
  "bomFormat": "CycloneDX",
  "specVersion": "1.4",
  "version": 1,
  "components": [
    {
      "type": "library",
      "name": "django",
      "version": "4.2.7",
      "purl": "pkg:pypi/django@4.2.7",
      "licenses": [
        {
          "license": {
            "id": "BSD-3-Clause"
          }
        }
      ]
    }
  ]
}
```

**Use cases:**
- DependencyTrack integration
- Automated vulnerability scanning
- CI/CD pipeline integration

### SPDX JSON

**Secondary format** - Linux Foundation standard

```json
{
  "spdxVersion": "SPDX-2.3",
  "dataLicense": "CC0-1.0",
  "SPDXID": "SPDXRef-DOCUMENT",
  "name": "backend",
  "packages": [
    {
      "name": "django",
      "versionInfo": "4.2.7",
      "licenseConcluded": "BSD-3-Clause"
    }
  ]
}
```

**Use cases:**
- Legal compliance
- License analysis
- Government/enterprise requirements

### SARIF

**Security format** - For vulnerability results

```json
{
  "version": "2.1.0",
  "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
  "runs": [
    {
      "tool": {
        "driver": {
          "name": "Trivy"
        }
      },
      "results": [
        {
          "ruleId": "CVE-2023-12345",
          "level": "error",
          "message": {
            "text": "Critical vulnerability in package xyz"
          }
        }
      ]
    }
  ]
}
```

**Use cases:**
- GitHub Security tab integration
- IDE integration
- Security dashboards

---

## Automated Generation

SBOMs are automatically generated by our CI/CD pipeline.

### Triggers

1. **Push to main branch**
   ```bash
   git push origin main
   ```

2. **Version tags**
   ```bash
   git tag v1.2.3
   git push origin v1.2.3
   ```

3. **Pull requests** (on main branch)
   ```bash
   gh pr create --base main
   ```

4. **Weekly schedule** (Sundays at midnight)
   - Automatic weekly SBOM refresh

5. **Manual trigger**
   - Via GitHub Actions UI
   - Workflow: "SBOM Generation"

### Pipeline Flow

```
┌─────────────────────┐
│ Build Docker Image  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Generate SBOM       │
│ - Syft (CycloneDX)  │
│ - Syft (SPDX)       │
│ - Trivy (CycloneDX) │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Scan Vulnerabilities│
│ - Grype             │
│ - Trivy             │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Upload to GitHub    │
│ Security Tab        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Upload Artifacts    │
│ (90 day retention)  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Upload to           │
│ DependencyTrack     │
└─────────────────────┘
```

### Artifacts

All SBOMs are saved as GitHub Actions artifacts:

- **Retention**: 90 days
- **Location**: Workflow run artifacts
- **Download**: Via GitHub Actions UI or API

### Failure Handling

Pipeline fails if:
- **Critical vulnerabilities found** (blocks deployment)
- **SBOM generation fails** (indicates tool issue)
- **Image build fails** (indicates code issue)

---

## Local Generation

Developers can generate SBOMs locally for testing and development.

### Prerequisites

Install required tools:

```bash
# Syft
curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

# Grype
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

# Trivy
# macOS
brew install trivy

# Linux
wget https://github.com/aquasecurity/trivy/releases/download/v0.48.0/trivy_0.48.0_Linux-64bit.tar.gz
tar -xzf trivy_0.48.0_Linux-64bit.tar.gz
sudo mv trivy /usr/local/bin/
```

### Generate for All Services

```bash
# From project root
./scripts/security/generate-sbom.sh
```

Output:
```
==========================================
  SBOM Generation Script
==========================================

Checking dependencies...
All dependencies satisfied
Output directory: ./sbom-reports/20231215_143022

==========================================
Processing: backend
==========================================
Building Docker image for backend...
Image built: backend:sbom-scan
Generating SBOM with Syft...
Syft SBOM generated
Generating SBOM with Trivy...
Trivy SBOM generated
Scanning for vulnerabilities with Grype...
Vulnerability scan complete
Scanning with Trivy...
Trivy scan complete
Generating summary report...
Summary report generated
✅ backend complete

[... continues for all services ...]

==========================================
  SBOM Generation Complete
==========================================
Successful: 9
Failed: 0
Output directory: ./sbom-reports/20231215_143022
Consolidated report: ./sbom-reports/20231215_143022/CONSOLIDATED_REPORT.md
```

### Generate for Single Service

```bash
# Generate SBOM for specific service
./scripts/security/generate-sbom.sh backend
```

### Output Structure

```
sbom-reports/
└── 20231215_143022/
    ├── CONSOLIDATED_REPORT.md
    ├── backend/
    │   ├── sbom-backend-cyclonedx.json
    │   ├── sbom-backend-spdx.json
    │   ├── sbom-backend-trivy.json
    │   ├── sbom-backend-table.txt
    │   ├── grype-results.json
    │   ├── grype-results.txt
    │   ├── trivy-scan.json
    │   ├── trivy-scan.txt
    │   └── SUMMARY.md
    ├── api-gateway/
    │   └── ...
    └── ...
```

---

## Vulnerability Scanning

Every SBOM is automatically scanned for vulnerabilities.

### Severity Levels

| Severity | Description | Action Required |
|----------|-------------|-----------------|
| **Critical** | Actively exploited, high impact | Fix immediately (< 24 hours) |
| **High** | Severe vulnerabilities | Fix within 1 week |
| **Medium** | Moderate risk | Fix within 1 month |
| **Low** | Minor issues | Fix in regular updates |

### Automated Scanning

Vulnerabilities are scanned with:

1. **Grype** - Comprehensive CVE database
2. **Trivy** - Container-focused vulnerabilities
3. **GitHub Dependabot** - Dependency updates

### Viewing Vulnerabilities

#### GitHub Security Tab

1. Go to repository "Security" tab
2. Click "Code scanning alerts"
3. Filter by service name
4. View vulnerability details

#### SBOM Report

View the summary report:

```bash
cat sbom-reports/latest/backend/SUMMARY.md
```

Output:
```markdown
# SBOM Summary - backend

**Generated**: 2023-12-15 14:30:22 UTC
**Image**: backend:sbom-scan

---

## Vulnerability Summary

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High     | 2 |
| Medium   | 5 |
| Low      | 12 |

---

## Critical & High Vulnerabilities

CVE-2023-12345 - django (High)
CVE-2023-67890 - pillow (High)
```

### Remediation Workflow

1. **Identify vulnerability**
   - Review SBOM scan results
   - Check severity and exploitability

2. **Update dependency**
   ```bash
   # Update in requirements.txt
   django==4.2.8  # Fixed version

   # Rebuild image
   docker build -t backend:latest .
   ```

3. **Re-scan**
   ```bash
   # Generate new SBOM
   ./scripts/security/generate-sbom.sh backend

   # Verify fix
   grep "Critical" sbom-reports/latest/backend/SUMMARY.md
   ```

4. **Deploy**
   ```bash
   # Merge fix
   git add requirements.txt
   git commit -m "fix(deps): update django to 4.2.8 (CVE-2023-12345)"
   git push
   ```

---

## DependencyTrack Integration

We optionally integrate with DependencyTrack for centralized SBOM management.

### What is DependencyTrack?

DependencyTrack is an open-source platform for:
- Centralized SBOM storage
- Continuous vulnerability monitoring
- Policy enforcement
- License compliance tracking

### Setup

1. **Deploy DependencyTrack**
   ```bash
   docker run -d -p 8080:8080 \
     --name dependencytrack \
     dependencytrack/bundled:latest
   ```

2. **Configure API Key**
   ```bash
   # In GitHub Secrets
   DTRACK_API_KEY=<your-api-key>
   DTRACK_URL=https://dependencytrack.example.com
   ```

3. **Automatic Upload**
   - SBOMs automatically uploaded on main branch commits
   - SBOMs uploaded on version tags
   - Projects created per service

### Viewing in DependencyTrack

1. Navigate to DependencyTrack UI
2. Browse projects: `ecommerce-backend`, `ecommerce-api-gateway`, etc.
3. View vulnerability metrics, trends, and compliance

---

## Compliance

### PCI-DSS

**Requirement 6.2**: Ensure all system components are protected from known vulnerabilities

SBOMs help us:
- Maintain inventory of components (Req 2.4)
- Track vulnerabilities (Req 6.2)
- Document patch management (Req 6.2)

### SOC 2

**CC7.2**: System monitoring

SBOMs provide:
- Change detection
- Vulnerability monitoring
- Compliance evidence

### Executive Order 14028

Federal requirement for SBOM in software:
- SBOMs generated in standard formats (CycloneDX, SPDX)
- SBOMs available to customers
- Vulnerability disclosure

### Evidence Collection

For audits, provide:
- SBOM artifacts from GitHub Actions
- Vulnerability scan results
- DependencyTrack reports
- Remediation timelines

---

## Best Practices

### For Developers

1. **Review SBOMs regularly**
   - Check SBOM reports in PRs
   - Monitor vulnerability counts

2. **Update dependencies proactively**
   - Don't wait for vulnerabilities
   - Keep dependencies current

3. **Use minimal base images**
   - Fewer packages = smaller attack surface
   - Alpine Linux for most services

4. **Pin dependency versions**
   - Reproducible builds
   - Controlled updates

### For Security Team

1. **Monitor DependencyTrack**
   - Set up alerts for new vulnerabilities
   - Review weekly vulnerability reports

2. **Triage vulnerabilities**
   - Prioritize based on exploitability
   - Consider CVSS score and context

3. **Track remediation**
   - Ensure fixes are deployed
   - Verify with new SBOM scans

4. **Audit SBOM process**
   - Quarterly review of SBOM generation
   - Validate coverage of all services

### For DevOps Team

1. **Maintain SBOM pipeline**
   - Ensure workflow runs successfully
   - Monitor artifact storage

2. **Rotate SBOM tools**
   - Update Syft, Grype, Trivy regularly
   - Test new tool versions

3. **Archive SBOMs**
   - Beyond 90-day GitHub retention
   - Store in long-term compliance archive

4. **Integrate with monitoring**
   - Alert on SBOM generation failures
   - Dashboard for vulnerability metrics

---

## Troubleshooting

### Issue: SBOM Generation Fails

**Symptoms**: Workflow fails at SBOM generation step

**Solutions**:
1. Check Docker image builds successfully
2. Verify Syft/Trivy are up to date
3. Check for disk space issues
4. Review tool error logs

### Issue: Too Many Vulnerabilities

**Symptoms**: Hundreds of vulnerabilities reported

**Solutions**:
1. Update base image (e.g., `python:3.11-slim` → newer version)
2. Update all dependencies
3. Consider switching base image (e.g., Alpine)
4. Review if all packages are necessary

### Issue: Missing Dependencies in SBOM

**Symptoms**: Known dependency not in SBOM

**Solutions**:
1. Ensure dependency is in requirements.txt (Python)
2. Check dependency is actually installed in image
3. Try alternative SBOM tool
4. Update Syft/Trivy to latest version

### Issue: DependencyTrack Upload Fails

**Symptoms**: SBOM not appearing in DependencyTrack

**Solutions**:
1. Verify DTRACK_API_KEY is correct
2. Check DependencyTrack URL is accessible
3. Review API key permissions
4. Check DependencyTrack logs

---

## Related Documentation

- [Security Scanning](./security-scanning.md)
- [Container Security Policy](./security-policies.md)
- [CI/CD Pipeline](../deployment/ci-cd-pipeline.md)
- [Vulnerability Management Process](./vulnerability-management.md)

---

## References

- CycloneDX: https://cyclonedx.org/
- SPDX: https://spdx.dev/
- Syft: https://github.com/anchore/syft
- Grype: https://github.com/anchore/grype
- Trivy: https://aquasecurity.github.io/trivy/
- DependencyTrack: https://dependencytrack.org/
- NTIA SBOM Minimum Elements: https://www.ntia.gov/report/2021/minimum-elements-software-bill-materials-sbom

---

## Appendix: SBOM Example

### Sample CycloneDX SBOM (Abbreviated)

```json
{
  "bomFormat": "CycloneDX",
  "specVersion": "1.4",
  "version": 1,
  "metadata": {
    "timestamp": "2023-12-15T14:30:22Z",
    "component": {
      "type": "container",
      "name": "backend",
      "version": "1.2.3"
    }
  },
  "components": [
    {
      "type": "library",
      "name": "django",
      "version": "4.2.7",
      "purl": "pkg:pypi/django@4.2.7",
      "licenses": [{"license": {"id": "BSD-3-Clause"}}],
      "hashes": [
        {
          "alg": "SHA-256",
          "content": "8e0f1c2..."
        }
      ]
    },
    {
      "type": "library",
      "name": "requests",
      "version": "2.31.0",
      "purl": "pkg:pypi/requests@2.31.0",
      "licenses": [{"license": {"id": "Apache-2.0"}}]
    }
  ],
  "dependencies": [
    {
      "ref": "pkg:pypi/django@4.2.7",
      "dependsOn": [
        "pkg:pypi/asgiref@3.7.2",
        "pkg:pypi/sqlparse@0.4.4"
      ]
    }
  ]
}
```

---

**Document Version**: 1.0
**Last Updated**: 2025-12-19
**Owner**: Security Team
**Review Cycle**: Quarterly
