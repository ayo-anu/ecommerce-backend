
groups:
  - name: checkout_alerts
    interval: 1m
    rules:
      - alert: HighCheckoutFailureRate
        expr: |
          (sum(rate(checkout_failed_total[10m]))
          /
          sum(rate(checkout_attempted_total[10m]))) > 0.10
        for: 5m
        labels:
          severity: critical
          category: business-critical
          impact: revenue
        annotations:
          summary: "High checkout failure rate"
          description: "Checkout failures at {{ $value | humanizePercentage }} (threshold: 10%)"
          impact: "Direct revenue loss, poor customer experience"
          action: "Check payment gateway, inventory service, and logs immediately"

      - alert: PaymentGatewayErrors
        expr: |
          rate(payment_errors_total[5m]) > 0.5
        for: 5m
        labels:
          severity: critical
          category: business-critical
          impact: revenue
        annotations:
          summary: "Payment gateway errors detected"
          description: "Payment errors at {{ $value }}/sec"
          impact: "Cannot process payments, revenue loss"
          action: "Check Stripe API status and credentials"

      - alert: DropInCheckoutRate
        expr: |
          (sum(rate(checkout_attempted_total[1h]))
          /
          sum(rate(checkout_attempted_total[1h] offset 24h))) < 0.5
        for: 30m
        labels:
          severity: warning
          category: business-trends
          impact: revenue
        annotations:
          summary: "Significant drop in checkout attempts"
          description: "Checkout rate dropped {{ (1 - $value) | humanizePercentage }} vs yesterday"
          impact: "Potential revenue impact"
          action: "Check for site issues, marketing campaigns, or seasonal factors"

  - name: order_alerts
    interval: 1m
    rules:
      - alert: FraudDetectionHighRejectionRate
        expr: |
          (sum(rate(fraud_detected_total[15m]))
          /
          sum(rate(orders_total[15m]))) > 0.20
        for: 10m
        labels:
          severity: warning
          category: fraud
          impact: revenue
        annotations:
          summary: "High fraud detection rejection rate"
          description: "{{ $value | humanizePercentage }} of orders flagged as fraud"
          impact: "Potential false positives blocking legitimate orders"
          action: "Review fraud detection thresholds and recent patterns"

      - alert: OrderProcessingBacklog
        expr: |
          order_processing_queue_size > 500
        for: 15m
        labels:
          severity: warning
          category: operations
        annotations:
          summary: "Order processing backlog"
          description: "{{ $value }} orders waiting to be processed"
          impact: "Delayed order fulfillment"
          action: "Scale order processing workers"

  - name: search_alerts
    interval: 1m
    rules:
      - alert: HighSearchFailureRate
        expr: |
          (sum(rate(search_errors_total[5m]))
          /
          sum(rate(search_requests_total[5m]))) > 0.05
        for: 5m
        labels:
          severity: warning
          category: search
        annotations:
          summary: "High search failure rate"
          description: "Search failures at {{ $value | humanizePercentage }}"
          impact: "Users cannot find products"
          action: "Check Elasticsearch health and query logs"

      - alert: LowSearchResultRate
        expr: |
          (sum(rate(search_no_results_total[10m]))
          /
          sum(rate(search_requests_total[10m]))) > 0.30
        for: 15m
        labels:
          severity: warning
          category: search
        annotations:
          summary: "High rate of searches with no results"
          description: "{{ $value | humanizePercentage }} searches return no results"
          impact: "Poor user experience, lost sales"
          action: "Review search index, synonyms, and product catalog"

  - name: recommendation_alerts
    interval: 1m
    rules:
      - alert: RecommendationEngineDown
        expr: up{service="recommendation-engine"} == 0
        for: 5m
        labels:
          severity: warning
          category: ai-features
        annotations:
          summary: "Recommendation engine is down"
          description: "Recommendation service unavailable"
          impact: "No personalized recommendations, reduced cross-sell"
          action: "Check recommendation service logs and restart"

      - alert: LowRecommendationCTR
        expr: |
          (sum(rate(recommendation_clicks_total[1h]))
          /
          sum(rate(recommendations_shown_total[1h]))) < 0.02
        for: 1h
        labels:
          severity: info
          category: ai-performance
        annotations:
          summary: "Low recommendation click-through rate"
          description: "CTR is {{ $value | humanizePercentage }} (typical: 2-5%)"
          impact: "Recommendations not engaging users"
          action: "Review model performance and retrain if needed"

  - name: inventory_alerts
    interval: 5m
    rules:
      - alert: CriticalStockLevel
        expr: product_stock_level < 5 and product_stock_level > 0
        for: 30m
        labels:
          severity: warning
          category: inventory
        annotations:
          summary: "Critical stock level for product {{ $labels.product_id }}"
          description: "Only {{ $value }} units remaining"
          impact: "Risk of stockout"
          action: "Review inventory and trigger reorder if needed"

      - alert: PricingEngineErrors
        expr: |
          rate(pricing_engine_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: pricing
        annotations:
          summary: "Pricing engine errors"
          description: "Pricing errors at {{ $value }}/sec"
          impact: "Products may show incorrect prices"
          action: "Check pricing engine logs and fallback logic"

  - name: auth_alerts
    interval: 1m
    rules:
      - alert: HighLoginFailureRate
        expr: |
          (sum(rate(login_failed_total[5m]))
          /
          sum(rate(login_attempted_total[5m]))) > 0.30
        for: 10m
        labels:
          severity: warning
          category: authentication
        annotations:
          summary: "High login failure rate"
          description: "Login failures at {{ $value | humanizePercentage }}"
          impact: "Users cannot access accounts"
          action: "Check for credential stuffing attacks or auth service issues"

      - alert: SuspiciousLoginActivity
        expr: |
          rate(login_failed_total[1m]) > 10
        for: 2m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Suspicious login activity detected"
          description: "{{ $value }} failed logins per second"
          impact: "Potential brute force attack"
          action: "Review rate limiting and implement additional security measures"

  - name: customer_experience_alerts
    interval: 5m
    rules:
      - alert: HighCartAbandonmentRate
        expr: |
          (sum(rate(cart_abandoned_total[1h]))
          /
          sum(rate(cart_created_total[1h]))) > 0.70
        for: 30m
        labels:
          severity: info
          category: customer-experience
        annotations:
          summary: "High cart abandonment rate"
          description: "{{ $value | humanizePercentage }} of carts are abandoned"
          impact: "Lost revenue opportunity"
          action: "Review checkout flow, shipping costs, and user experience"

      - alert: IncreaseInCustomerSupport
        expr: |
          sum(rate(support_tickets_created_total[1h])) > (sum(rate(support_tickets_created_total[1h] offset 24h)) * 1.5)
        for: 1h
        labels:
          severity: info
          category: customer-support
        annotations:
          summary: "Spike in customer support tickets"
          description: "Support volume up {{ ($value - 1) * 100 }}% vs yesterday"
          impact: "Potential product or service issue"
          action: "Review recent tickets for patterns"

  - name: revenue_alerts
    interval: 5m
    rules:
      - alert: SignificantRevenueDropoff
        expr: |
          (sum(rate(revenue_total[1h]))
          /
          sum(rate(revenue_total[1h] offset 24h))) < 0.6
        for: 1h
        labels:
          severity: critical
          category: business-critical
          impact: revenue
        annotations:
          summary: "Significant revenue drop detected"
          description: "Revenue down {{ (1 - $value) | humanizePercentage }} vs yesterday"
          impact: "Major revenue impact"
          action: "Immediate investigation - check all critical services"

      - alert: ZeroRevenueWindow
        expr: |
          sum(rate(revenue_total[30m])) == 0
        for: 30m
        labels:
          severity: critical
          category: business-critical
          impact: revenue
        annotations:
          summary: "No revenue in the last 30 minutes"
          description: "Zero completed orders with revenue"
          impact: "Complete revenue stoppage"
          action: "URGENT: Check payment gateway, checkout flow, and all critical services"
